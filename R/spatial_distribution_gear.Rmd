---
title: "Spatial Distribution - Gear Types"
output: html_notebook
---

```{r, include=FALSE}
library(readxl)
library(tidyverse)
library(maps)
library(rgdal) # for shapefiles
```

# Housekeeping
```{r, echo=TRUE}
file_path <- "/Volumes/GoogleDrive/Shared drives/emlab/projects/current-projects/blue-prosperity-coalition/data/Azores/"
```

# Load Data
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Fleet Data
fleet_path <- paste0(file_path, "azores-fishing-vessel-licenses/")
fleet_list <- list.files(fleet_path, pattern="xlsx")

# Consolidate all fleet data into one dataframe
fleet_data <- NULL
for(file in fleet_list){
  temp <- read_xlsx(paste0(fleet_path, file))
  if(file == "Fleet_2009.xlsx") { 
    colnames(temp)[3] <- "Loa"}
  if(file %in% c("Fleet_2015.xlsx", "Fleet_2016.xlsx", "Fleet_2017.xlsx", "Fleet_2018.xlsx")) { 
    temp <- temp %>% 
      mutate("Gear ranking" = NA)
  }
  temp <- temp %>% 
    select(Year, Vessel_ID_Code, Loa, `Gear ranking`, Gear, Caracteristics)
  fleet_data <- rbind(fleet_data, temp)
}

# Logbooks
log_path <- paste0(file_path, "LogBooks_FoA&WF_2009_2018/")
log_list <- list.files(log_path, pattern = "xlsx")

# Consolidate all logbook data into one dataframe
logbook_data <- NULL
for(file in log_list){
  temp <- read_xlsx(paste0(log_path, file), sheet="CATCH")
  temp <- temp[,1:18]
  logbook_data <- rbind(logbook_data, temp)
}

# VMS Data
vms_path <- paste0(file_path, "VMS_FoA&WF_2016_18/")
vms_list <- list.files(vms_path, pattern="xlsx")

# Consolidate all vms data into one dataframe
vms_data <- NULL
for(file in vms_list){ 
  temp <- read_xlsx(paste0(vms_path, file))
  vms_data <- rbind(vms_data, temp)
}

# Clean Up
remove(temp)
```

# Clean Data - Vessel Licenses
```{r, echo=TRUE}
# Make sure all rows have characteristic data
fleet_data <- fleet_data %>% 
  mutate(Caracteristics = ifelse(is.na(Caracteristics), tolower(Gear), tolower(Caracteristics)), 
         Gear = ifelse(is.na(Gear), tolower(Gear), tolower(Gear)))
```
Several vessels are registered for both bottom longline and handline in the same year. 

# Clean Data - Logbooks
```{r, echo=TRUE}
# Only keep fleet data from fishers who use either handlines or bottom longlines
fleet_data <- fleet_data %>% 
  filter(grepl("handline|bottom longline", Caracteristics) | grepl("handline|bottom longline", Gear)) %>% 
  mutate(gear = ifelse(grepl("handline|bottom longline", Caracteristics), Caracteristics, Gear)) %>% 
  select(-Gear, -Caracteristics)

# Only keep logbook data that have either bottom longline or handline gear
logbook_data <- logbook_data %>% 
  filter(GEAR %in% c("Palangre de fundo", "Linha de mão")) %>% 
  mutate(GEAR = gsub("Palangre de fundo", "bottom longline", GEAR), 
         GEAR = gsub("Linha de mão", "handline", GEAR))

# Convert date to posix
logbook_data <- logbook_data %>% 
  mutate(DATE_INI = as.POSIXct(DATE_INI, format="%y.%m.%d"), 
         DATE_END = as.POSIXct(DATE_END, format="%y.%m.%d"))
```

All logbook data that are either Linha de mão (handline) or Palangre de fundo (bottom longline) have no GPS coordinates. 

# Quick Check for 2018 vessels
```{r}
both_gears_2018 <- fleet_data %>% 
  filter(Year == 2018) %>% 
  select(Vessel_ID_Code, gear) %>%
  distinct_all() %>% 
  group_by(Vessel_ID_Code) %>% 
  summarise(n = n()) %>% 
  filter(n > 1)

nrow(both_gears_2018)
```


# Clean Data - VMS
```{r, echo=TRUE}
# Add date column so we can merge with the logbook data
vms_data <- vms_data %>% 
  mutate(date = format(`Date / Hour`, format="%Y-%m-%d"), 
         date = as.POSIXct(date, format="%Y-%m-%d"))
```

# Add Logbook Data to VMS 
```{r, echo=TRUE}
vms_data <- vms_data %>% 
  left_join(logbook_data, by=c("date" = "DATE_INI", "Vessel_ID_Code")) %>% 
  filter(!is.na(DATE_END))
```

# Grab Unique Fishing Locations
```{r, echo=TRUE}
# Data are recorded as species catch, but we really just want to see the spatial distribution of fishing locations by gear type
vms_locations <- vms_data %>% 
  select(Vessel_ID_Code, `Date / Hour`, Latitude, Longitude, GEAR) %>% 
  distinct_all()
```


# Map it! 
```{r message=FALSE, warning=FALSE}
# Read in EEZ shapefile
eez <- readOGR(paste0(file_path, "spatial_data/azores_EEZ.shp"))
```
 
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Create plot
map <- ggplot() + 
  geom_polygon(data = eez, aes(x = long, y = lat, group = group, fill=hole), colour = "black") +
  scale_fill_manual(values=alpha(c("slategray3", "white"), c(0.4, 1)), guide="none") +
  xlab("Longitude (DD)") + ylab("Latitude (DD)") + 
  theme_void() + 
  theme(panel.background = element_rect(fill="slategray1"))

layer <- map + 
  geom_point(vms_locations, mapping = aes(x=Longitude, y=Latitude, color=GEAR), alpha=0.5)

layer
```

```{r, echo=TRUE}
layer + coord_map(xlim = c(-26, -25), ylim=c(37,38))
```

If we use just the datasets that are present in this dataframe, we might be able to tease out different areas that are used for bottom longlines and handlines. However, it seems like there may be data that are missing that would potentially show a complete overlap of both gear types. It doesn't seem like handlines are limited to the coastal areas; handline geartypes are logged just as far offshore as bottom longlines.

Now we can compare it to the VMS shapefile for the bottom longline fishery that was generated by the University of Azores.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Add some Azores VMS generated data for bottom longlines
vms_shp <- readOGR(paste0(file_path, "Telmo/VMS_data/Bottom_Longline/BLL_Raw.shp"))
vms_dots <- as.data.frame(vms_shp)

# Create new dataframe that has the old handline data and the new bottom longline data
new_vms <- vms_locations %>% 
  filter(GEAR == "handline") %>% 
  select(Latitude, Longitude, GEAR) %>% 
  add_row(vms_dots %>% 
            mutate(GEAR = "bottom longline") %>% 
            select(Latitude, Longitude, GEAR))
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Create plot
map <- ggplot() + 
  geom_polygon(data = eez, aes(x = long, y = lat, group = group, fill=hole), colour = "black") +
  scale_fill_manual(values=alpha(c("slategray3", "white"), c(0.4, 1)), guide="none") + 
  xlab("Longitude (DD)") + ylab("Latitude (DD)") + 
  theme_void() + 
  theme(panel.background = element_rect(fill="slategray1"))

layer <- map + geom_point(new_vms, mapping = aes(x=Longitude, y=Latitude, color=GEAR), alpha=0.5)

layer
```

```{r, echo=TRUE}
layer + coord_map(xlim = c(-26, -25), ylim=c(37,38))
```